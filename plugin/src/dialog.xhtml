<?xml version="1.0"?>
<?xml-stylesheet href="chrome://global/skin/" type="text/css"?>
<?xml-stylesheet href="chrome://zotero/skin/zotero.css" type="text/css"?>
<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">

<head>
  <title>Ask Question - Zotero RAG</title>
  <meta charset="utf-8"/>
  <script>
    document.addEventListener("DOMContentLoaded", (ev) => {
      try {
        Services.scriptloader.loadSubScript(
          "chrome://zotero/content/include.js",
          this
        );
      } catch (e) {
        console.error("Failed to load include.js:", e);
      }

      // Load dialog script
      try {
        Services.scriptloader.loadSubScript(
          "chrome://zotero-rag/content/dialog.js",
          window
        );
      } catch (e) {
        console.error("Failed to load dialog.js:", e);
      }
    });
  </script>
  <style>
    /* Inline styles */
    body { margin: 0; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; height: 100vh; overflow: hidden; box-sizing: border-box; }
    .dialog-container { display: flex; flex-direction: column; height: 100%; }
    .dialog-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .form-group { margin-bottom: 15px; flex-shrink: 0; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
    .question-input { width: 100%; padding: 8px; font-family: inherit; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; resize: vertical; }
    .library-list { border: 1px solid #ccc; padding: 8px; height: 120px; overflow-y: auto; box-sizing: border-box; line-height: 1.5; }
    .library-checkbox { display: block; padding: 1px 0; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .library-checkbox input { margin: 0 4px 0 0; vertical-align: middle; }
    .library-status-icon { font-size: 13px; vertical-align: middle; display: none; }
    .library-name { font-weight: 500; font-size: 13px; vertical-align: middle; }
    .library-meta { font-size: 11px; color: #666; vertical-align: middle; margin-left: 6px; }
    .indexing-mode-select { width: 100%; padding: 6px; font-family: inherit; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    .mode-description { margin-top: 5px; font-size: 12px; color: #666; min-height: 18px; }
    .feedback-container { height: 120px; margin-bottom: 15px; flex-shrink: 0; }
    .progress-section { height: 100%; padding: 10px; background-color: #f5f5f5; border-radius: 4px; box-sizing: border-box; display: flex; flex-direction: column; }
    .progress-label { font-weight: 500; margin-bottom: 5px; }
    #progress-bar { width: 100%; height: 20px; margin-bottom: 8px; }
    .progress-message { font-size: 13px; color: #666; flex: 1; overflow-y: auto; }
    .status-section { height: 100%; padding: 10px; background-color: #fff5f5; border: 1px solid #ffcccc; border-radius: 4px; box-sizing: border-box; }
    .status-messages { height: 100%; overflow-y: auto; padding: 5px; background-color: #fafafa; border-radius: 3px; }
    .status-message { padding: 4px 0; font-size: 12px; }
    .status-message.info { color: #0066cc; }
    .status-message.success { color: #008000; }
    .status-message.error { color: #cc0000; }
    .dialog-buttons { display: flex; justify-content: flex-end; gap: 10px; padding-top: 15px; border-top: 1px solid #ddd; flex-shrink: 0; }
    .dialog-button { padding: 8px 20px; border: 1px solid #ccc; border-radius: 4px; background-color: #f5f5f5; color: #333; cursor: pointer; }
    .dialog-button:hover { background-color: #e5e5e5; }
    .dialog-button:disabled { opacity: 0.5; cursor: not-allowed; background-color: #f5f5f5; }
    .dialog-button:disabled:hover { background-color: #f5f5f5; }
    .dialog-button.primary { background-color: #0066cc; color: #fff; border-color: #0066cc; }
    .dialog-button.primary:hover { background-color: #0052a3; }
    .dialog-button.primary:disabled { opacity: 0.5; cursor: not-allowed; background-color: #0066cc; }
    .dialog-button.primary:disabled:hover { background-color: #0066cc; }
  </style>
</head>

<body>
  <div class="dialog-container">
    <div class="dialog-content">
      <!-- Question input -->
      <div class="form-group">
        <label for="question-input">Question:</label>
        <textarea id="question-input"
                  rows="4"
                  placeholder="Enter your question here..."
                  class="question-input"></textarea>
      </div>

      <!-- Similarity threshold -->
      <div class="form-group">
        <label for="similarity-threshold">
          Similarity threshold: <span id="similarity-value">0.3</span>
        </label>
        <input type="range"
               id="similarity-threshold"
               min="0.0"
               max="1.0"
               step="0.1"
               value="0.3"
               style="width: 100%;" />
        <div style="font-size: 11px; color: #666; margin-top: 3px;">
          Lower values return more results but may be less relevant
        </div>
      </div>

      <!-- Library selection -->
      <div class="form-group">
        <label>Select libraries to search:</label>
        <div id="library-list" class="library-list">
          <!-- Libraries will be populated by JavaScript -->
        </div>
      </div>

      <!-- Indexing mode selection -->
      <div class="form-group">
        <label for="indexing-mode">Indexing mode:</label>
        <select id="indexing-mode" class="indexing-mode-select">
          <option value="auto" selected="selected">Auto (Recommended)</option>
          <option value="incremental">Quick Update (Incremental)</option>
          <option value="full">Full Reindex</option>
        </select>
        <div class="mode-description">
          <span id="mode-auto-desc" class="mode-desc-text">Automatically chooses the best indexing method</span>
          <span id="mode-incremental-desc" class="mode-desc-text" style="display: none;">Only indexes new or modified items</span>
          <span id="mode-full-desc" class="mode-desc-text" style="display: none;">Reindexes entire library (slower)</span>
        </div>
      </div>

      <!-- Feedback container (fixed height) -->
      <div class="feedback-container">
        <!-- Progress section (always visible) -->
        <div id="progress-section" class="progress-section">
          <div id="progress-label" class="progress-label">Ready</div>
          <progress id="progress-bar" max="100" value="0"></progress>
          <div id="progress-message" class="progress-message"></div>
        </div>

        <!-- Status messages (shown only on errors, replaces progress) -->
        <div id="status-section" class="status-section" style="display: none;">
          <div style="font-weight: 500; margin-bottom: 5px; color: #cc0000;">Error Details:</div>
          <div id="status-messages" class="status-messages">
            <!-- Status messages will be added here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Dialog buttons -->
    <div class="dialog-buttons">
      <button id="cancel-button" type="button" class="dialog-button" title="Close this dialog">Close</button>
      <button id="submit-button" type="button" class="dialog-button primary">Submit</button>
    </div>
  </div>
</body>
</html>
